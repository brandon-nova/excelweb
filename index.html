<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SPXL Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      margin:0;
      font-family:system-ui,sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:2rem;
      background:#fafafa;
      color:#222;
    }
    h1 {
      margin-bottom:1.5rem;
      font-size:1.8rem;
    }
    .row {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:1rem;
      width:100%;
      max-width:800px;
      margin-bottom:1rem;
    }
    .card {
      background:#fff;
      padding:1rem;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      text-align:center;
      transition:background .2s,color .2s;
      color:#222; /* Default text color */
    }
    .label {
      font-size:.85rem;
      color:#555;
    }
    .value {
      font-size:1.4rem;
      margin-top:.3rem;
      font-weight:600;
    }
    /* Card background helpers */
    .bg-orange { background: #f88920 !important; }
    .bg-green { background: #159b35 !important; }
    .bg-red   { background: #c82a2a !important; }
    .white-text { color: #fff !important; }
    .black-text { color: #222 !important; }
    /* Text up/down for last and open */
    .text-green { color: #159b35 !important; }
    .text-red { color: #c82a2a !important; }
  </style>
</head>
<body>
  <h1>SPXL Dashboard</h1>

  <div class="row">
    <div class="card"><div class="label">SPXL Last</div><div id="last" class="value">–</div></div>
    <div class="card"><div class="label">Open</div><div id="open" class="value">–</div></div>
    <div class="card"><div class="label">Range</div><div id="range" class="value">–</div></div>
    <div class="card"><div class="label">C-O%</div><div id="co" class="value">–</div></div>
  </div>

  <div class="row">
    <div class="card"><div class="label">H-O%</div><div id="ho" class="value">–</div></div>
    <div class="card"><div class="label">O-L%</div><div id="ol" class="value">–</div></div>
    <div class="card"><div class="label">PrevH</div><div id="prevH" class="value">–</div></div>
    <div class="card"><div class="label">PrevL</div><div id="prevL" class="value">–</div></div>
  </div>

  <div class="row">
    <div class="card"><div class="label">2% from Open</div><div id="p2" class="value">–</div></div>
    <div class="card"><div class="label">1% from Open</div><div id="p1" class="value">–</div></div>
    <div class="card"><div class="label">–2% from Open</div><div id="m2" class="value">–</div></div>
    <div class="card"><div class="label">–1% from Open</div><div id="m1" class="value">–</div></div>
  </div>

  <!-- 4th row: Today High/Low, PrevH/PrevL -->
  <div class="row">
    <div class="card"><div class="label">Today High</div><div id="todayHigh" class="value">–</div></div>
    <div class="card"><div class="label">Today Low</div><div id="todayLow" class="value">–</div></div>
    <div class="card"><div class="label">Gap</div><div id="gap" class="value">–</div></div>
  </div>

  <div id="error"></div>
  <div id="lastRefreshed" class="label" style="margin-top:1rem">
    Last refreshed: –
  </div>

  <script>
    const API_KEY = 'd12vjkhr01qv1k0nill0d12vjkhr01qv1k0nillg';

    // Keep last price in memory for tick-comparison
    let lastTick = null;

    // Helper to set card bg and text color
    function setCardBg(id, bgClass) {
      const card = document.getElementById(id).parentElement;
      card.classList.remove('bg-orange', 'bg-green', 'bg-red', 'white-text', 'black-text');
      if (bgClass) {
        card.classList.add(bgClass);
        card.classList.add('white-text');
      } else {
        card.classList.add('black-text');
      }
    }

    // Helper for just text color (used for last and open)
    function setTextColor(id, colorClass) {
      const el = document.getElementById(id);
      el.classList.remove('text-green', 'text-red');
      if (colorClass) el.classList.add(colorClass);
    }

    async function fetchData() {
  const API_KEY = 'your_key_here';

  // 1) today’s quote
  const { o: open, h: high, l: low, c: last, pc: prevClose } = await fetch(
    `https://finnhub.io/api/v1/quote?symbol=SPXL&token=${API_KEY}`
  ).then(r => r.ok ? r.json() : Promise.reject('Quote fetch failed'));

  // 2) yesterday’s H/L via /stock/candle with timestamp range
  let prevH = null, prevL = null;
  try {
    const now = Math.floor(Date.now() / 1000);
    const oneDay = 60 * 60 * 24;
    const from = now - 3 * oneDay; // look back 3 days
    const to = now;

    const cdl = await fetch(
      `https://finnhub.io/api/v1/stock/candle?symbol=SPXL&resolution=D&from=${from}&to=${to}&token=${API_KEY}`
    ).then(r => r.ok ? r.json() : Promise.reject('Candle fetch failed'));

    if (cdl.s === 'ok' && cdl.h.length >= 2) {
      const len = cdl.h.length;
      prevH = cdl.h[len - 2];
      prevL = cdl.l[len - 2];
    }
  } catch (e) {
    console.error('Candle fetch error:', e);
  }

  return { open, high, low, last, prevClose, prevH, prevL };
}


    function fmt(x, pct = false) {
      if (x == null) return '–';
      return pct
        ? (x * 100).toFixed(2) + '%'
        : (+x).toFixed(2);
    }

    function updateUI({ open, high, low, last, prevClose, prevH, prevL }) {
      // Derived numbers
      const range = (high - low) / open;
      const co    = (last - open) / open;
      const ho    = (high - last) / open;
      const ol    = (last - low) / open;
      const gap   = (open - prevClose) / prevClose;
      const offs  = [0.02, 0.01, -0.02, -0.01].map(p => open * (1 + p));
      // "Last" card: compare to last tick value (except on first load)
      setTextColor('last', null);
      if (lastTick !== null && last > lastTick) setTextColor('last', 'text-green');
      else if (lastTick !== null && last < lastTick) setTextColor('last', 'text-red');
      document.getElementById('last').textContent = fmt(last);

      // "Open" card: green if close > open, else red
      setTextColor('open', null);
      if (last > open) setTextColor('open', 'text-green');
      else if (last < open) setTextColor('open', 'text-red');
      document.getElementById('open').textContent = fmt(open);

      // Range: orange > 6%
      setCardBg('range', range > 0.06 ? 'bg-orange' : '');
      document.getElementById('range').textContent = fmt(range, true);

      // C-O%
      document.getElementById('co').textContent = fmt(co, true);

      // H-O%: green if >2%
      setCardBg('ho', ho > 0.02 ? 'bg-green' : '');
      document.getElementById('ho').textContent = fmt(ho, true);

      // O-L%: red if < -2%
      setCardBg('ol', ol < -0.02 ? 'bg-red' : '');
      document.getElementById('ol').textContent = fmt(ol, true);

      // Gap card (row 2)
      let gapBg = '';
      if (gap > 0.01) gapBg = 'bg-green';
      else if (gap < -0.01) gapBg = 'bg-red';
      setCardBg('gap', gapBg);
      document.getElementById('gap').textContent = fmt(gap, true);

      // 2% from Open: green if C-O% > 2%; red if H-O% > 2% and C-O% < 2%
      let p2bg = '';
      if (co > 0.02) p2bg = 'bg-green';
      if (ho > 0.02 && co < 0.02) p2bg = 'bg-red';
      setCardBg('p2', p2bg);
      document.getElementById('p2').textContent = fmt(offs[0]);

      // -2% from Open: red if C-O% < -2%; green if O-L% < -2% and C-O% > -2%
      let m2bg = '';
      if (co < -0.02) m2bg = 'bg-red';
      if (ol < -0.02 && co > -0.02) m2bg = 'bg-green';
      setCardBg('m2', m2bg);
      document.getElementById('m2').textContent = fmt(offs[2]);

      // -1% from Open: red if C-O% < -1%
      setCardBg('m1', co < -0.01 ? 'bg-red' : '');
      document.getElementById('m1').textContent = fmt(offs[3]);

      // 1% from Open: green if C-O% > 1%
      setCardBg('p1', co > 0.01 ? 'bg-green' : '');
      document.getElementById('p1').textContent = fmt(offs[1]);

      // Row 4: Today high/low and PrevH/PrevL
      document.getElementById('todayHigh').textContent = fmt(high);
      document.getElementById('todayLow').textContent = fmt(low);

      // PrevH: green when last > prevH, red when last < prevH
      let prevHbg = '';
      if (prevH != null && last > prevH) prevHbg = 'bg-green';
      if (prevH != null && last < prevH) prevHbg = 'bg-red';
      setCardBg('prevH', prevHbg);
      document.getElementById('prevH').textContent = fmt(prevH);

      // PrevL: red when last < prevL, green when last > prevL
      let prevLbg = '';
      if (prevL != null && last < prevL) prevLbg = 'bg-red';
      if (prevL != null && last > prevL) prevLbg = 'bg-green';
      setCardBg('prevL', prevLbg);
      document.getElementById('prevL').textContent = fmt(prevL);

      // Update lastTick for next tick
      lastTick = last;
    }

    async function refresh() {
      try {
        const data = await fetchData();
        updateUI(data);
        // update timestamp
        const now = new Date();
        document.getElementById('lastRefreshed').textContent =
          'Last refreshed: ' + now.toLocaleTimeString();
      } catch (e) {
        document.getElementById('error').textContent = e;
      }
    }

    // run once, then every minute
    refresh();
    setInterval(refresh, 60_000);
  </script>
</body>
</html>
