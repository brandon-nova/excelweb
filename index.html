<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SPXL Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      margin:0;
      font-family:system-ui,sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:2rem;
      background:#fafafa;
      color:#222;
    }
    h1 {
      margin-bottom:1.5rem;
      font-size:1.8rem;
    }
    .row {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:1rem;
      width:100%;
      max-width:800px;
      margin-bottom:1rem;
    }
    .card {
      background:#fff;
      padding:1rem;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      text-align:center;
      transition:background .2s,color .2s;
      color:#222;
    }
    .label {
      font-size:.85rem;
      color:#555;
    }
    .value {
      font-size:1.4rem;
      margin-top:.3rem;
      font-weight:600;
    }
    .bg-orange { background: #f88920 !important; }
    .bg-green { background: #159b35 !important; }
    .bg-red   { background: #c82a2a !important; }
    .bg-yellow { background: #f9e33c !important; }
    .white-text { color: #fff !important; }
    .black-text { color: #222 !important; }
    .text-green { color: #159b35 !important; }
    .text-red { color: #c82a2a !important; }
    .text-black { color: #222 !important; }
  </style>
</head>
<body>
  <h1>SPXL Dashboard</h1>

  <!-- Cards same as original (unchanged for brevity) -->

  <div class="row">
    <div class="card"><div class="label">PrevH</div><div id="prevH" class="value">–</div></div>
    <div class="card"><div class="label">Top</div><div id="r1" class="value">–</div></div>
    <div class="card"><div class="label">PrevL</div><div id="prevL" class="value">–</div></div>
    <div class="card"><div class="label">Bottom Pivot</div><div id="s1" class="value">–</div></div>
  </div>

  <div class="row">
    <div class="card"><div class="label">2% Open</div><div id="p2" class="value">–</div></div>
    <div class="card"><div class="label">Last</div><div id="last" class="value">–</div></div>
    <div class="card"><div class="label">1% Open</div><div id="p1" class="value">–</div></div>
    <div class="card"><div class="label">C-O%</div><div id="co" class="value">–</div></div>    
  </div>

  <div class="row">
    <div class="card"><div class="label">Open</div><div id="open" class="value">–</div></div>
    <div class="card"><div class="label">Range</div><div id="range" class="value">–</div></div>
    <div class="card"><div class="label">–1% Open</div><div id="m1" class="value">–</div></div>
    <div class="card"><div class="label">H-O%</div><div id="ho" class="value">–</div></div>
  </div>

  <div class="row">
    <div class="card"><div class="label">–2% Open</div><div id="m2" class="value">–</div></div>
    <div class="card"><div class="label">O-L%</div><div id="ol" class="value">–</div></div>
    <div class="card"><div class="label">Gap%</div><div id="gap" class="value">–</div></div>
    <div class="card"><div class="label">Gap</div><div id="gapDir" class="value">–</div></div>
  </div>
  
  <div class="row">
    <div class="card"><div class="label">Today High</div><div id="todayHigh" class="value">–</div></div>
    <div class="card"><div class="label">Today Low</div><div id="todayLow" class="value">–</div></div>
  </div>

  <div id="error"></div>
  <div id="lastRefreshed" class="label" style="margin-top:1rem">
    Last refreshed: –
  </div>

  <script>
    const API_KEY = 'd12vjkhr01qv1k0nill0d12vjkhr01qv1k0nillg';
    const ALPHA_VANTAGE_API_KEY = 'XRYG08MMAVHPSCHM';

    let lastTick = null;
    let alphaVantageCache = { prevH: null, prevL: null, lastFetchedTimestamp: 0 };
    const ONE_DAY_MS = 86400000;

    function setCardBg(id, bgClass) {
      const card = document.getElementById(id).parentElement;
      card.classList.remove('bg-orange', 'bg-green', 'bg-red', 'bg-yellow', 'white-text', 'black-text');
      if (bgClass) {
        card.classList.add(bgClass);
        card.classList.add('white-text');
      } else {
        card.classList.add('black-text');
      }
    }

    function setTextColor(id, colorClass) {
      const el = document.getElementById(id);
      el.classList.remove('text-green', 'text-red', 'text-black');
      if (colorClass) el.classList.add(colorClass);
    }

    async function fetchData() {
      const { o: open, h: high, l: low, c: last, pc: prevClose } = await fetch(
        `https://finnhub.io/api/v1/quote?symbol=SPXL&token=${API_KEY}`
      ).then(r => r.ok ? r.json() : Promise.reject('Quote fetch failed'));

      const now = Date.now();
      if (alphaVantageCache.prevH !== null && (now - alphaVantageCache.lastFetchedTimestamp < ONE_DAY_MS)) {
        return { open, high, low, last, prevClose, prevH: alphaVantageCache.prevH, prevL: alphaVantageCache.prevL };
      }

      const res = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=SPXL&outputsize=compact&apikey=${ALPHA_VANTAGE_API_KEY}`);
      const data = await res.json();
      const dates = Object.keys(data["Time Series (Daily)"] || {}).sort((a, b) => new Date(b) - new Date(a));
      const previousDayCandle = data["Time Series (Daily)"]?.[dates[1]];
      const prevH = parseFloat(previousDayCandle["2. high"]);
      const prevL = parseFloat(previousDayCandle["3. low"]);

      alphaVantageCache = { prevH, prevL, lastFetchedTimestamp: now };
      return { open, high, low, last, prevClose, prevH, prevL };
    }

    function fmt(x, pct = false) {
      if (x == null) return '–';
      return pct ? (x * 100).toFixed(2) + '%' : (+x).toFixed(2);
    }

    function updateUI({ open, high, low, last, prevClose, prevH, prevL }) {
      const range = (high - low) / open;
      const co = (last - open) / open;
      const ho = (high - open) / open;
      const ol = (open - low) / open;
      const gap = (open - prevClose) / prevClose;
      const offs = [0.02, 0.01, -0.02, -0.01].map(p => open * (1 + p));
      const pp = (high + low + prevClose) / 3;
      const s1 = (2 * pp) - high;
      const r1 = (2 * pp) - low;

      document.getElementById('s1').textContent = fmt(s1);
      setCardBg('s1', (last < s1) ? 'bg-red' : (low < s1 && last > s1 ? 'bg-green' : ''));

      document.getElementById('r1').textContent = fmt(r1);
      setCardBg('r1', (last > r1) ? 'bg-green' : (high > r1 && last < r1 ? 'bg-red' : ''));

      setTextColor('last', null);
      if (lastTick !== null && last > lastTick) setTextColor('last', 'text-green');
      else if (lastTick !== null && last < lastTick) setTextColor('last', 'text-red');
      setCardBg('last', 'bg-yellow');
      document.getElementById('last').textContent = fmt(last);

      setTextColor('open', last > open ? 'text-green' : last < open ? 'text-red' : '');
      document.getElementById('open').textContent = fmt(open);

      setCardBg('range', range > 0.04 ? 'bg-orange' : '');
      document.getElementById('range').textContent = fmt(range, true);

      setTextColor('co', co > 0 ? 'text-green' : co < 0 ? 'text-red' : 'text-black');
      document.getElementById('co').textContent = fmt(co, true);

      setCardBg('ho', ho > 0.02 ? 'bg-green' : '');
      document.getElementById('ho').textContent = fmt(ho, true);

      setCardBg('ol', ol < -0.02 ? 'bg-red' : '');
      document.getElementById('ol').textContent = fmt(ol, true);

      setCardBg('gap', gap > 0.01 ? 'bg-green' : gap < -0.01 ? 'bg-red' : '');
      document.getElementById('gap').textContent = fmt(gap, true);

      const gapDir = document.getElementById('gapDir');
      gapDir.textContent = '–';
      setCardBg('gapDir', '');
      if (gap > 0.01 && last > open) { gapDir.textContent = '↑'; setCardBg('gapDir', 'bg-green'); }
      else if (gap < -0.01 && last < open) { gapDir.textContent = '↓'; setCardBg('gapDir', 'bg-red'); }

      document.getElementById('p2').textContent = fmt(offs[0]);
      setCardBg('p2', (co > 0.02) ? 'bg-green' : (last < offs[0] && high > offs[0] ? 'bg-red' : ''));

      document.getElementById('p1').textContent = fmt(offs[1]);
      setCardBg('p1', (co > 0.01) ? 'bg-green' : (last < offs[1] && high > offs[1] ? 'bg-red' : ''));

      document.getElementById('m2').textContent = fmt(offs[2]);
      setCardBg('m2', (co < -0.02) ? 'bg-red' : (last > offs[2] && low < offs[2] ? 'bg-green' : ''));

      document.getElementById('m1').textContent = fmt(offs[3]);
      setCardBg('m1', (co < -0.01) ? 'bg-red' : (last > offs[3] && low < offs[3] ? 'bg-green' : ''));

      setCardBg('prevH', last > prevH ? 'bg-green' : '');
      document.getElementById('prevH').textContent = fmt(prevH);

      setCardBg('prevL', last < prevL ? 'bg-red' : '');
      document.getElementById('prevL').textContent = fmt(prevL);

      setTextColor('todayHigh', high > prevH ? 'text-green' : 'text-black');
      document.getElementById('todayHigh').textContent = fmt(high);

      setTextColor('todayLow', low < prevL ? 'text-red' : 'text-black');
      document.getElementById('todayLow').textContent = fmt(low);

      lastTick = last;
    }

    async function refresh() {
      try {
        const data = await fetchData();
        updateUI(data);
        document.getElementById('lastRefreshed').textContent =
          'Last refreshed: ' + new Date().toLocaleTimeString();
      } catch (e) {
        document.getElementById('error').textContent = e;
      }
    }

    refresh();
    setInterval(refresh, 60000);
  </script>
</body>
</html>
